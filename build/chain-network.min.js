/**
 * [chain-network]{@link https://github.com/emn178/chain-network}
 *
 * @version 0.2.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2017
 */
(function(){function m(a,b){var c=2<arguments.length||"object"!=typeof b?arguments:b;return a.replace(/\{(\w+)\}/g,function(b,a){return a in c?c[a]:"{"+a+"}"})}function d(a,b){var c=this;this.element=a;this.pageSize=b.pageSize||10;this.projectColor=b.projectColor||"#f0ad4e";this.projectTooltipTemplate=b.project.tooltipTemplate||"Target: {target}<br/>Current: {incomingValue}({incomingPercentage}%)<br/>Used: {outgoingValue}({outgoingPercentage}%)";this.incomingEdgeColor=b.incomingEdgeColor||"#02c66c";
this.outgoingEdgeColor=b.outgoingEdgeColor||"#ff0000";this.project=b.project;this.nodesMap={};this.nodes=b.nodes||[];this.nodes.forEach(function(a){c.nodesMap[a.id]=a});this.networkNodes=[];this.networkEdges=[];this.incomingNodeIds={};this.transcationsMap={};this.aggEdgesMap={};this.transcations=b.transcations||[];var g=0,e=0;this.transcations.forEach(function(a){c.transcationsMap[a.id]=a;var b,k=!1,d;a.to===c.project.id?(c.incomingNodeIds[a.from]=!0,b=c.incomingEdgeColor,g+=a.value,d=!0):(b=c.outgoingEdgeColor,
c.incomingNodeIds[a.to]&&(k=!0),e+=a.value,d=!1);var f=a.from+"_"+a.to;c.aggEdgesMap[f]||(b=$.extend({arrows:"to",color:b,dashes:k,arrowStrikethrough:!1,smooth:k?{type:"continuous"}:!1},a),b.id=f,delete b.value,c.networkEdges.push(b),c.aggEdgesMap[f]={id:f,transcations:[],edge:b,incoming:d});d=c.aggEdgesMap[f];d.transcations.push(a);d.value=d.transcations.reduce(function(a,c){return a+c.value},0)});Object.keys(this.aggEdgesMap).forEach(function(a){a=c.aggEdgesMap[a];a.edge.width=a.value/(a.incoming?
g:e)*20;a.edge.width=5<a.edge.width?5:Math.max(a.edge.width,1)});this.incomingNodes=[];this.outgoingNodes=[];this.nodes.forEach(function(a){c.incomingNodeIds[a.id]?c.incomingNodes.push(a):c.outgoingNodes.push(a)});var d=g/b.project.target*100,h=e/g*100,f='<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" ><foreignObject><div xmlns="http://www.w3.org/1999/xhtml" style="width: 50px;height: 50px;background-color: #d0d0d0;position: relative;border-radius: 50%; overflow: hidden;"><div style="width: 100%;height: '+
Math.min(d,100).toFixed(2)+'%;background-color: #02c66c;position: absolute;bottom: 0"><div style="width: 100%;height: '+h.toFixed(2)+'%;background-color: #ff0000;position: absolute;bottom: 0"></div></div></div></foreignObject></svg>',f="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(f),d=m(this.projectTooltipTemplate,{target:b.project.target,incomingValue:g,incomingPercentage:d.toFixed(2),outgoingValue:e,outgoingPercentage:h.toFixed(2)});this.rootNode=this.createNode(b.project,1,{image:f,shape:"image",
color:this.projectColor,fixed:!0,title:d});this.rootNode.label="";this.network=new vis.Network(a[0],{nodes:[],edges:[]},$.extend({layout:{hierarchical:{direction:"UD"}},edges:{smooth:{roundness:.5}},interaction:{dragView:!1,zoomView:!1}},b.vis));this.network.on("select",function(b){if(b.nodes.length){var d=c.nodesMap[b.nodes[0]];d?a.trigger("chain:node",[b.pointer,d]):-1!==b.nodes[0].indexOf("_PAGE_")&&(d=b.nodes[0].split("_"),"incoming"===d[0]?c.setIncomingPage(parseInt(d[2])):c.setOutgoingPage(parseInt(d[2])));
if(b.nodes[0]===c.project.id)return}b.edges.length&&(d=c.aggEdgesMap[b.edges[0]])&&a.trigger("chain:transcation",[b.pointer,d.transcations])});this.incomingPage=this.outgoingPage=1;this.incomingPages=this.calculatePages(this.incomingNodes.length);this.outgoingPages=this.calculatePages(this.outgoingNodes.length);this.render()}d.prototype.calculatePages=function(a){if(a<=this.pageSize)return 1;if(a<=2*(this.pageSize-1))return 2;a-=2*(this.pageSize-1);return Math.ceil(a/(this.pageSize-2))+2};d.prototype.setIncomingPage=
function(a){this.incomingPage!==a&&(this.incomingPage=a,this.render())};d.prototype.setOutgoingPage=function(a){this.outgoingPage!==a&&(this.outgoingPage=a,this.render())};d.prototype.render=function(){var a=this;this.pageEdges=[];this.prePageEdges=[];this.networkNodes=[this.rootNode];this.getNodesByType("incoming").forEach(function(b){a.addNode(b,0)});this.getNodesByType("outgoing").forEach(function(b){a.addNode(b,2)});var b={nodes:this.networkNodes,edges:this.prePageEdges.concat(this.networkEdges.concat(this.pageEdges))};
this.network.setData(b)};d.prototype.getNodesByType=function(a){var b,c,d;"incoming"===a?(b=this.incomingNodes,c=this.incomingPage,d=this.incomingPages):(b=this.outgoingNodes,c=this.outgoingPage,d=this.outgoingPages);var e;1===c?(e=0,size=1===this.incomingPages?this.pageSize:this.pageSize-1):c===d?(e=this.pageSize-1+(this.pageSize-2)*(c-2),size=this.pageSize-1):(e=this.pageSize-1+(this.pageSize-2)*(c-2),size=this.pageSize-2);end=e+size;b=b.slice(e,end);1!==c&&b.unshift(this.createPageNode(a,c-1,this.prePageEdges,
"Previous Group"));c!==d&&b.push(this.createPageNode(a,c+1,this.pageEdges,"Next Group"));return b};d.prototype.createPageNode=function(a,b,c,d){var e,g,h,f=a+"_PAGE_"+b;"incoming"===a?(e=f,g=this.project.id,h=this.incomingEdgeColor):(e=this.project.id,g=f,h=this.outgoingEdgeColor);c.push({id:a+"_PAGE_"+b,arrows:"to",from:e,to:g,color:h,arrowStrikethrough:!1,smooth:!1});return{id:f,label:d,group:"page"}};d.prototype.addNode=function(a,b,c){this.networkNodes.push(this.createNode(a,b,c))};d.prototype.createNode=
function(a,b,c){return $.extend({level:b,physics:!1},c,a)};var l=!1;$.fn.chainNetwork=function(a){var b=new d(this,a);if(!l){var c=$('<i class="fa fa-user" style="display:none"></i>');$("body").append(c);setTimeout(function(){b.network.redraw();c.remove()},50);l=!0}return this.data("KEY",b)}})();
