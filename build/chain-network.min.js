/**
 * [chain-network]{@link https://github.com/emn178/chain-network}
 *
 * @version 0.1.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2017
 */
(function(){function r(d,b){var c=2<arguments.length||"object"!=typeof b?arguments:b;return d.replace(/\{(\w+)\}/g,function(b,d){return d in c?c[d]:"{"+d+"}"})}function h(d,b){var c=this;this.element=d;this.pageSize=b.pageSize||10;this.projectColor=b.projectColor||"#f0ad4e";this.projectTooltipTemplate=b.project.tooltipTemplate||"Target: {target}<br/>Current: {incomingValue}({incomingPercentage}%)<br/>Used: {outgoingValue}({outgoingPercentage}%)";this.incomingEdgeColor=b.incomingEdgeColor||"#02c66c";
this.outgoingEdgeColor=b.outgoingEdgeColor||"#ff0000";this.project=b.project;this.nodesMap={};this.nodes=b.nodes||[];this.nodes.forEach(function(a){c.nodesMap[a.id]=a});this.networkNodes=[];this.networkEdges=[];this.incomingNodeIds={};this.transcationsMap={};this.transcations=b.transcations||[];var g=0,l=0;this.transcations.forEach(function(a){c.transcationsMap[a.id]=a;var b,d=!1;a.to===c.project.id?(c.incomingNodeIds[a.from]=!0,b=c.incomingEdgeColor,g+=a.value):(b=c.outgoingEdgeColor,c.incomingNodeIds[a.to]&&
(d=!0),l+=a.value);a=$.extend({arrows:"to",color:b,dashes:d,label:a.value},a);c.networkEdges.push(a)});var e=Math.ceil(this.pageSize/2),f=Object.keys(this.incomingNodeIds).length,h=f>e,k=this.nodes.length-f>e,p=0,q=0,m;this.nodes.forEach(function(a){c.incomingNodeIds[a.id]?(m=h?p%2?0:1:1,++p):(m=k?q%2?4:3:3,++q);c.addNode(a,m)});var e=g/b.project.target*100,f=l/g*100,n='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" ><foreignObject><div xmlns="http://www.w3.org/1999/xhtml" style="width: 20px;height: 20px;background-color: #d0d0d0;position: relative;border-radius: 50%; overflow: hidden;"><div style="width: 100%;height: '+
Math.min(e,100).toFixed(2)+'%;background-color: #02c66c;position: absolute;bottom: 0"><div style="width: 100%;height: '+f.toFixed(2)+'%;background-color: #ff0000;position: absolute;bottom: 0"></div></div></div></foreignObject></svg>',n="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(n),e=r(this.projectTooltipTemplate,{target:b.project.target,incomingValue:g,incomingPercentage:e,outgoingValue:l,outgoingPercentage:f});this.addNode(b.project,2,{image:n,shape:"image",color:this.projectColor,fixed:!0,
title:e});this.network=new vis.Network(d[0],{nodes:this.networkNodes,edges:this.networkEdges},$.extend({layout:{hierarchical:{direction:"LR"}},edges:{smooth:{roundness:.5}}},b.vis));this.network.on("select",function(a){a.nodes.length?(a=c.nodesMap[a.nodes[0]])&&d.trigger("chain:node",a):a.edges.length&&(a=c.transcationsMap[a.edges[0]])&&d.trigger("chain:transcation",a)})}h.prototype.addNode=function(d,b,c){d=$.extend({level:b,physics:!1},c,d);this.networkNodes.push(d)};var k=!1;$.fn.chainNetwork=
function(d){var b=new h(this,d);if(!k){var c=$('<i class="fa fa-user" style="display:none"></i>');$("body").append(c);setTimeout(function(){b.network.redraw();c.remove()},50);k=!0}return this.data("KEY",b)}})();
