/**
 * [chain-network]{@link https://github.com/emn178/chain-network}
 *
 * @version 0.1.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2017
 */
(function(){function m(a,b){var c=2<arguments.length||"object"!=typeof b?arguments:b;return a.replace(/\{(\w+)\}/g,function(b,a){return a in c?c[a]:"{"+a+"}"})}function d(a,b){var c=this;this.element=a;this.pageSize=b.pageSize||5;this.projectColor=b.projectColor||"#f0ad4e";this.projectTooltipTemplate=b.project.tooltipTemplate||"Target: {target}<br/>Current: {incomingValue}({incomingPercentage}%)<br/>Used: {outgoingValue}({outgoingPercentage}%)";this.incomingEdgeColor=b.incomingEdgeColor||"#02c66c";
this.outgoingEdgeColor=b.outgoingEdgeColor||"#ff0000";this.project=b.project;this.nodesMap={};this.nodes=b.nodes||[];this.nodes.forEach(function(a){c.nodesMap[a.id]=a});this.networkNodes=[];this.networkEdges=[];this.incomingNodeIds={};this.transcationsMap={};this.transcations=b.transcations||[];var f=0,e=0;this.transcations.forEach(function(a){c.transcationsMap[a.id]=a;var b,k=!1;a.to===c.project.id?(c.incomingNodeIds[a.from]=!0,b=c.incomingEdgeColor,f+=a.value):(b=c.outgoingEdgeColor,c.incomingNodeIds[a.to]&&
(k=!0),e+=a.value);a=$.extend({arrows:"to",color:b,dashes:k,label:a.value},a);c.networkEdges.push(a)});this.incomingNodes=[];this.outgoingNodes=[];this.nodes.forEach(function(a){c.incomingNodeIds[a.id]?c.incomingNodes.push(a):c.outgoingNodes.push(a)});var d=f/b.project.target*100,h=e/f*100,g='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" ><foreignObject><div xmlns="http://www.w3.org/1999/xhtml" style="width: 20px;height: 20px;background-color: #d0d0d0;position: relative;border-radius: 50%; overflow: hidden;"><div style="width: 100%;height: '+
Math.min(d,100).toFixed(2)+'%;background-color: #02c66c;position: absolute;bottom: 0"><div style="width: 100%;height: '+h.toFixed(2)+'%;background-color: #ff0000;position: absolute;bottom: 0"></div></div></div></foreignObject></svg>',g="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(g),d=m(this.projectTooltipTemplate,{target:b.project.target,incomingValue:f,incomingPercentage:d.toFixed(2),outgoingValue:e,outgoingPercentage:h.toFixed(2)});this.rootNode=this.createNode(b.project,1,{image:g,shape:"image",
color:this.projectColor,fixed:!0,title:d});this.network=new vis.Network(a[0],{nodes:[],edges:[]},$.extend({layout:{hierarchical:{direction:"LR"}},edges:{smooth:{roundness:.5}}},b.vis));this.network.on("select",function(b){if(b.nodes.length){var d=c.nodesMap[b.nodes[0]];d?a.trigger("chain:node",d):(b=b.nodes[0].split("_"),"incoming"===b[0]?c.setIncomingPage(parseInt(b[2])):c.setoutgoingPage(parseInt(b[2])))}else b.edges.length&&(b=c.transcationsMap[b.edges[0]])&&a.trigger("chain:transcation",b)});
this.incomingPage=this.outgoingPage=1;this.incomingPages=this.calculatePages(this.incomingNodes.length);this.outgoingPages=this.calculatePages(this.outgoingNodes.length);this.render()}d.prototype.calculatePages=function(a){if(a<=this.pageSize)return 1;if(a<=2*(this.pageSize-1))return 2;a-=2*(this.pageSize-1);return Math.ceil(a/(this.pageSize-2))+2};d.prototype.setIncomingPage=function(a){this.incomingPage!==a&&(this.incomingPage=a,this.render())};d.prototype.setoutgoingPage=function(a){this.outgoingPage!==
a&&(this.outgoingPage=a,this.render())};d.prototype.render=function(){var a=this;this.pageEdges=[];this.prePageEdges=[];this.networkNodes=[this.rootNode];this.getNodesByType("incoming").forEach(function(b){a.addNode(b,0)});this.getNodesByType("outgoing").forEach(function(b){a.addNode(b,2)});var b={nodes:this.networkNodes,edges:this.prePageEdges.concat(this.networkEdges.concat(this.pageEdges))};this.network.setData(b)};d.prototype.getNodesByType=function(a){var b,c,d;"incoming"===a?(b=this.incomingNodes,
c=this.incomingPage,d=this.incomingPages):(b=this.outgoingNodes,c=this.outgoingPage,d=this.outgoingPages);var e;1===c?(e=0,size=1===this.incomingPages?this.pageSize:this.pageSize-1):c===d?(e=this.pageSize-1+(this.pageSize-2)*(c-2),size=this.pageSize-1):(e=this.pageSize-1+(this.pageSize-2)*(c-2),size=this.pageSize-2);end=e+size;b=b.slice(e,end);1!==c&&b.unshift(this.createPageNode(a,c-1,this.prePageEdges,"Previous Group"));c!==d&&b.push(this.createPageNode(a,c+1,this.pageEdges,"Next Group"));return b};
d.prototype.createPageNode=function(a,b,c,d){var e,f,h,g=a+"_PAGE_"+b;"incoming"===a?(e=g,f=this.project.id,h=this.incomingEdgeColor):(e=this.project.id,f=g,h=this.outgoingEdgeColor);c.push({id:a+"_PAGE_EDGE_"+b,arrows:"to",from:e,to:f,color:h});return{id:g,label:d,group:"page"}};d.prototype.addNode=function(a,b,c){this.networkNodes.push(this.createNode(a,b,c))};d.prototype.createNode=function(a,b,c){return $.extend({level:b,physics:!1},c,a)};var l=!1;$.fn.chainNetwork=function(a){var b=new d(this,
a);if(!l){var c=$('<i class="fa fa-user" style="display:none"></i>');$("body").append(c);setTimeout(function(){b.network.redraw();c.remove()},50);l=!0}return this.data("KEY",b)}})();
